#{extends 'main.html' /}
#{set title:'FaceRating' /}
<div id="fb-root"></div>
<script src="http://connect.facebook.net/en_US/all.js"></script>
<div class="row" id="container" >
	<div class="col col_10" id="left_container">
		<h1>Face Rating System</h1>
		<form id="url-form" method="post" action="">
			<fieldset class="s_column">
				<label>Url<label>
				<input type="text" name="url" id="url-to-view"/>
				<input type="submit" value="GO"/>
			</fieldset>
		</form>
	
	
	
		<div id="url-content">
			${getUrl_html?.raw()}
		</div>
	
	</div>
	<div class="col col_6" id="right_container">
		<h1>What did you think ?</h1>
		<div id="stream-container" class="container">
			<div id="publisher-container">
				<div id="publisher"></div>				
			</div>
			<div class="button-container">
				<button id="ratingButton" style="display: none">FaceRate it</button>
			</div>
		</div>
	</div>
	<form id="send-image" method="POST">
		<input type="hidden" name="img" id="img-data"/>
		<input type="hidden" name="url" id="url-data"/>
	</form>
	
	</div>
	<div class="row" id="rate-container">
		<h3>What others thought :</h3>
		#{if sharedUrl && sharedUrl.images}
			#{list items:sharedUrl.images.values(), as:'image'}
				<img src="${image.imageUrl}"/>
			#{/list}
		#{/if}
		#{else}
			Be the first saying something!
		#{/else}
	</div>
	<div class="row">
		<div class="col col_16" id="footer">
			<h3>Powered by</h3>
			<img src="http://developers.face.com/wordpress/wp-content/uploads/2010/04/logo_500_138-300x82.png" class="logo"/>&nbsp;
			<img src="http://embed.ly/static/images/logos/embedly-powered-large-light.png" class="logo"/>&nbsp;
			<img src="http://static.opentok.com/opentok/assets/img/shared/logos/opentok-logo.png" class="logo"/>
		</div>
		<a id="share-via-facebook">Texte1</a>
	</div>

<script src="http://staging.tokbox.com/v0.91/js/TB.min.js" ></script>
<script type="text/javascript">
$(document).ready(function() {
	var apiKey = '3106852';
	var sessionId = '2d0800d33d4d1f7cd70c71dacdb828bef5c8ee4a';
	var token = 'devtoken';	
	var publisher;
	var session = TB.initSession(sessionId);
	
	// Set up event listeners
	session.addEventListener('sessionConnected', sessionConnectedHandler);
	session.addEventListener('streamCreated', streamCreatedHandler);
	session.connect(apiKey, token);
	
	// On session connect handler
	function sessionConnectedHandler(event) {
		var div = document.createElement('div');
		div.setAttribute('id', 'publisher');
		
		document.getElementById('publisher').appendChild(div);
		
		publisher = session.publish(div.id);
	}
	
	// On stream created handler
	function streamCreatedHandler(event) {
		for (var i = 0; i < event.streams.length; i++) {
			// Enable the identify button as soon as the publisher hits 'Allow'
			if (event.streams[i].connection.connectionId == session.connection.connectionId) {
				$("#ratingButton").css("display", "block");
			}
		}
	}
	
	function getUrlContent(url) {
		var data = $('#url-form').serialize();
		console.log(data);
		$.ajax({
			url: '@@{Application.getLinkHTML}',
			data: data,
			type: "POST",
			crossDomain: true,
			success: function(response) {
				drawUrlContent(response);
			}
		});
	}
	
	function sendRateToServer(imgData) {
		var data = $('#send-image').serialize();
		console.log('Sending to the server ' + data);
		console.log(data);
		$.ajax({
			url: '@@{Application.uploadRating}',
			data: data,
			type: "POST",
			crossDomain: true,
			success: function(response) {
				//do something
			}
		});
	}

	function drawUrlContent(content) {
		$('#url-content').html(content);
	}
	$('#url-form').submit(function(e){
		console.log('submiting form');
		e.preventDefault();
		var url = $('#url-to-view').attr('value');
		$('#url-data').attr('value', url);
		getUrlContent(url);
	});
	
	$("#ratingButton").click(function(e) {
		e.preventDefault();
		var imgData = publisher.getImgData();
		var img = $('<img>');
		img.attr('src', "data:image/gif;base64," + imgData);
		$("#rate-container").append($('<div>').append(img));
		$('#img-data').attr('value', imgData);
		sendRateToServer();
	});
	
	 $('#share-via-facebook').click(function () {
      	var fblink = "http://www.facebook.com/dialog/feed?app_id=";
		var app_id ="257826280912359";
		var link ="";
		var picture ="";
		var message ="I feel neutral";
		var redirect_uri= "http://google.com"
		fblink += app_id;
		fblink += "&link="+link;
		fblink += "&picture="+picture;
		fblink += "&message="+message;
		fblink += "&redirect_uri="+redirect_uri;
	  	window.open(fblink,'mywindow','width=400,height=400');
     })
	
	
	console.log('Finished');
});
</script>
<script src="@{'/public/javascripts/face-rating.js'}" type="text/javascript" charset="utf-8"></script>
